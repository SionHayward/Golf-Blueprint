<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Shot Analysis Dashboard</title>
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/zone-performance.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">The Golf Blueprint</a>
            <ul class="nav-links">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="round-details.html" class="nav-link">Record Round</a></li>
                <li><a href="shot-analysis.html" class="nav-link">Shot Analysis</a></li>
                <li id="auth-link"><a href="login.html" class="nav-link">Login</a></li>
                <li id="profile-link" style="display: none;"><a href="profile.html" class="nav-link">My Profile</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Shot Analysis Dashboard</h1>
            <p>Analyze your shots to identify patterns and improve your game strategy</p>
        </div>

        <div class="dashboard-filters">
            <div class="filter-group">
                <label for="hole-select">Hole:</label>
                <select id="hole-select">
                    <option value="1">Hole 1 - Par 4</option>
                    <option value="2">Hole 2 - Par 3</option>
                    <option value="3">Hole 3 - Par 5</option>
                    <option value="4">Hole 4 - Par 4</option>
                    <option value="5">Hole 5 - Par 5</option>
                    <option value="6">Hole 6 - Par 3</option>
                    <option value="7">Hole 7 - Par 4</option>
                    <option value="8">Hole 8 - Par 5</option>
                    <option value="9">Hole 9 - Par 3</option>
                    <option value="10">Hole 10 - Par 4</option>
                    <option value="11">Hole 11 - Par 3</option>
                    <option value="12">Hole 12 - Par 4</option>
                    <option value="13">Hole 13 - Par 5</option>
                    <option value="14">Hole 14 - Par 4</option>
                    <option value="15">Hole 15 - Par 4</option>
                    <option value="16">Hole 16 - Par 4</option>
                    <option value="17">Hole 17 - Par 3</option>
                    <option value="18">Hole 18 - Par 4</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="shot-number">Shot Number:</label>
                <select id="shot-number">
                    <option value="all">All Shots</option>
                    <option value="1">Tee Shot</option>
                    <option value="2">Approach Shot</option>
                    <option value="3">Chip/Pitch</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="date-range">Time Period:</label>
                <select id="date-range">
                    <option value="all-time">All Time</option>
                    <option value="this-year">This Year</option>
                    <option value="last-5">Last 5 Rounds</option>
                    <option value="last-10">Last 10 Rounds</option>
                </select>
            </div>
        </div>

        <div class="dashboard-charts">
            <div class="chart-card">
                <h2>Average Score by Zone</h2>
                <div id="score-chart" class="chart-container">
                    <div class="loading-placeholder">
                        <p>Select a hole to view score data...</p>
                    </div>
                </div>
            </div>
            
            <div class="chart-card">
                <h2>Shot Distribution</h2>
                <div id="distribution-chart" class="chart-container">
                    <div class="loading-placeholder">
                        <p>Select a hole to view distribution data...</p>
                    </div>
                </div>
            </div>
            
            <div class="chart-card hole-visualization">
                <div class="hole-svg-container" id="hole-visualization">
                    <img id="hole-image" src="" alt="Hole Image">
                    <!-- Zone highlights will be dynamically added here -->
                </div>
                
                <div class="zone-stats">
                    <h2>Zone Performance</h2>
                    <table id="zone-stats-table">
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>Avg. Score</th>
                                <th>Times Hit</th>
                                <th>Best Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Example data that will be dynamically replaced -->
                            <tr>
                                <td>Green</td>
                                <td class="score-cell">3.5</td>
                                <td>8</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Fairway</td>
                                <td class="score-cell">4.2</td>
                                <td>15</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Long Right</td>
                                <td class="score-cell">4.0</td>
                                <td>5</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Short Right</td>
                                <td class="score-cell">4.8</td>
                                <td>6</td>
                                <td>4</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Load auth.js first -->
    <script src="scripts/auth.js"></script>
    
    <!-- Then load dashboard-specific script -->
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners for filter changes
    document.getElementById('hole-select').addEventListener('change', updateDashboard);
    document.getElementById('shot-number').addEventListener('change', updateDashboard);
    document.getElementById('date-range').addEventListener('change', updateDashboard);
    
    // Function to load hole-specific CSS
    function loadHoleCSS(holeNumber) {
        // Remove any existing hole-specific CSS
        const existingLink = document.getElementById('hole-specific-css');
        if (existingLink) {
            existingLink.remove();
        }
        
        // Add the new CSS link
        const link = document.createElement('link');
        link.id = 'hole-specific-css';
        link.rel = 'stylesheet';
        link.href = `styles/zones/hole${holeNumber}zones.css`;
        document.head.appendChild(link);
        
        console.log(`Loaded CSS: styles/zones/hole${holeNumber}zones.css`);
    }
    
    // Function to update the dashboard based on selected filters
    function updateDashboard() {
        const holeNumber = document.getElementById('hole-select').value;
        const shotNumber = document.getElementById('shot-number').value;
        const dateRange = document.getElementById('date-range').value;
        
        console.log(`Updating dashboard for hole ${holeNumber}, shot ${shotNumber}, period ${dateRange}`);
        
        // Update hole image
        const holeImage = document.getElementById('hole-image');
        holeImage.src = `images/${holeNumber}.svg`;
        holeImage.alt = `Hole ${holeNumber}`;
        
        // Load hole-specific CSS
        loadHoleCSS(holeNumber);
        
        // Add hole-specific class to visualization container
        const container = document.getElementById('hole-visualization');
        container.className = `hole-svg-container hole${holeNumber}`;
        
        // Add all the zone elements (they'll be invisible but can be highlighted)
        addZoneElements(container, holeNumber);
        
        // Fetch data from API
        fetchHoleData(holeNumber, shotNumber, dateRange);
    }
    
    // Function to add zone elements to the container
    function addZoneElements(container, holeNumber) {
        // Clear existing zones first
        const existingZones = container.querySelectorAll('.zone');
        existingZones.forEach(zone => zone.remove());
        
        // For hole 1, add all the zones from your CSS
        if (holeNumber === '1') {
            const zoneIds = [
                'teebox', 'short-fairway', 'mid-fairway', 'long-fairway',
                'short-right-rough', 'short-left-rough', 'mid-right-rough', 'mid-left-rough',
                'long-right-rough', 'long-left-rough', 'green', 'short-left', 'short-right',
                'long-left', 'long-right', 'lake', 'left-green-side', 'mid-left-trees',
                'short-left-trees', 'right-green-side', 'outer-rough'
            ];
            
            zoneIds.forEach(id => {
                const zone = document.createElement('div');
                zone.id = id;
                zone.className = 'zone';
                zone.dataset.zoneName = idToZoneName(id);
                container.appendChild(zone);
            });
        }
        // Add other holes similar to the above
        // ...
    }
    
    // Convert ID to zone name
    function idToZoneName(id) {
        // Convert hyphenated IDs to properly formatted zone names
        return id.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
    // Convert zone name to ID
    function zoneNameToId(name) {
        // Convert zone names from database to CSS IDs
        return name.toLowerCase().replace(/ /g, '-');
    }
    
    // Enhanced zone visualization for shot analysis
    function updateZonePerformanceVisualization(zoneData, holeNumber) {
        const container = document.getElementById('hole-visualization');
        
        // Reset any existing zone styling
        const zones = container.querySelectorAll('.zone');
        zones.forEach(zone => {
            zone.style.backgroundColor = '';
            zone.classList.remove('good-zone', 'bad-zone', 'neutral-zone');
            zone.style.opacity = '0';
        });
        
        // If no data, return
        if (!zoneData || zoneData.length === 0) return;
        
        // Find the range of scores to normalize the coloring
        let minScore = Infinity;
        let maxScore = -Infinity;
        
        zoneData.forEach(zone => {
            if (zone.avgScore < minScore) minScore = zone.avgScore;
            if (zone.avgScore > maxScore) maxScore = zone.avgScore;
        });
        
        // Calculate median score as reference point
        const scores = zoneData.map(zone => zone.avgScore);
        scores.sort((a, b) => a - b);
        const medianScore = scores.length % 2 === 0 
            ? (scores[scores.length/2 - 1] + scores[scores.length/2]) / 2 
            : scores[Math.floor(scores.length/2)];
        
        // Apply coloring to each zone
        zoneData.forEach(zone => {
            // Convert zone name to id format
            const zoneId = zoneNameToId(zone.zone);
            const zoneElement = document.getElementById(zoneId);
            
            if (zoneElement) {
                // Determine zone status (good, neutral, bad)
                let zoneStatus;
                let opacity;
                
                // Calculate performance relative to median
                const scoreDiff = zone.avgScore - medianScore;
                const normalizedDiff = scoreDiff / (maxScore - minScore) * 2; // Scale to -1 to 1 range
                
                if (zone.avgScore < medianScore - (maxScore - minScore) * 0.15) {
                    zoneStatus = 'good-zone';
                    // Darker green for better zones
                    opacity = 0.4 + Math.min(0.5, Math.abs(normalizedDiff) * 0.5);
                    zoneElement.style.backgroundColor = `rgba(76, 175, 80, ${opacity})`;
                } else if (zone.avgScore > medianScore + (maxScore - minScore) * 0.15) {
                    zoneStatus = 'bad-zone';
                    // Darker red for worse zones
                    opacity = 0.4 + Math.min(0.5, Math.abs(normalizedDiff) * 0.5);
                    zoneElement.style.backgroundColor = `rgba(244, 67, 54, ${opacity})`;
                } else {
                    zoneStatus = 'neutral-zone';
                    opacity = 0.3;
                    zoneElement.style.backgroundColor = `rgba(255, 193, 7, ${opacity})`;
                }
                
                // Add status class
                zoneElement.classList.add(zoneStatus);
                
                // Make zone visible (as it starts with opacity 0)
                zoneElement.style.opacity = '1';
                
                // Add tooltip
                zoneElement.title = `${zone.zone}: Avg. Score ${zone.avgScore.toFixed(1)} (${zone.count} shots)`;
                
                // Add click handler
                zoneElement.addEventListener('click', () => {
                    highlightTableRow(zone.zone);
                });
            }
        });
        
        // Add legend
        addPerformanceLegend(container);
    }

    // Add a legend explaining the colors
    function addPerformanceLegend(container) {
        // Remove existing legend if present
        const existingLegend = document.getElementById('zone-legend');
        if (existingLegend) existingLegend.remove();
        
        const legend = document.createElement('div');
        legend.id = 'zone-legend';
        legend.className = 'zone-legend';
        legend.innerHTML = `
            <div class="legend-title">Zone Performance</div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: rgba(76, 175, 80, 0.6);"></span>
                <span class="legend-label">Best Scoring Areas</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: rgba(255, 193, 7, 0.4);"></span>
                <span class="legend-label">Average Scoring Areas</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: rgba(244, 67, 54, 0.6);"></span>
                <span class="legend-label">Challenging Areas</span>
            </div>
        `;
        
        container.appendChild(legend);
    }
    
    // Function to fetch hole data from API
    function fetchHoleData(holeNumber, shotNumber, dateRange) {
        // Show loading state
        document.getElementById('score-chart').innerHTML = '<div class="loading-placeholder"><p>Loading data...</p></div>';
        document.getElementById('distribution-chart').innerHTML = '<div class="loading-placeholder"><p>Loading data...</p></div>';
        
        // Fetch data from API
        fetch(`/api/hole-stats?hole=${holeNumber}&shot=${shotNumber}&datePeriod=${dateRange}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response:', data);
                
                if (data && data.zones && data.zones.length > 0) {
                    // Update visualizations
                    updateZonePerformanceVisualization(data.zones, holeNumber);
                    updateZoneStatsTable(data.zones);
                    updateScoreChart(data.zones, data.par);
                    updateDistributionChart(data.zones);
                } else {
                    // Handle no data case
                    document.getElementById('score-chart').innerHTML = 
                        '<div class="loading-placeholder"><p>No data available for this hole</p></div>';
                    document.getElementById('distribution-chart').innerHTML = 
                        '<div class="loading-placeholder"><p>No data available for this hole</p></div>';
                    updateZonePerformanceVisualization([], holeNumber);
                    updateZoneStatsTable([]);
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('score-chart').innerHTML = 
                    `<div class="loading-placeholder"><p>Error: ${error.message}</p></div>`;
                document.getElementById('distribution-chart').innerHTML = 
                    `<div class="loading-placeholder"><p>Error: ${error.message}</p></div>`;
            });
    }
    
    // Highlight a table row
    function highlightTableRow(zoneName) {
        const table = document.getElementById('zone-stats-table');
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const rowZone = row.querySelector('td').textContent;
            if (rowZone === zoneName) {
                row.style.backgroundColor = '#e9f7e9';
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                row.classList.add('highlighted');
            } else {
                row.style.backgroundColor = '';
                row.classList.remove('highlighted');
            }
        });
    }
    
    // Highlight a zone element
    function highlightZoneElement(zoneId) {
        const zoneElement = document.getElementById(zoneId);
        if (!zoneElement) return;
        
        // Add temporary class to highlight the zone
        zoneElement.classList.add('zone-active');
        zoneElement.classList.add('pulse-animation');
        
        // Flash effect
        setTimeout(() => {
            zoneElement.classList.remove('zone-active');
            zoneElement.classList.remove('pulse-animation');
        }, 1500);
    }
    
    // Update zone stats table
    function updateZoneStatsTable(zoneData) {
        const tableBody = document.querySelector('#zone-stats-table tbody');
        tableBody.innerHTML = '';
        
        if (!zoneData || zoneData.length === 0) {
            return;
        }
        
        // Sort zones by average score (best to worst)
        zoneData.sort((a, b) => a.avgScore - b.avgScore);
        
        zoneData.forEach(zone => {
            const row = document.createElement('tr');
            
            const zoneCell = document.createElement('td');
            zoneCell.textContent = zone.zone;
            
            const scoreCell = document.createElement('td');
            scoreCell.className = 'score-cell';
            scoreCell.textContent = zone.avgScore.toFixed(1);
            
            const countCell = document.createElement('td');
            countCell.textContent = zone.count;
            
            const bestCell = document.createElement('td');
            bestCell.textContent = zone.bestScore;
            
            row.appendChild(zoneCell);
            row.appendChild(scoreCell);
            row.appendChild(countCell);
            row.appendChild(bestCell);
            
            // Add click handler to highlight the zone
            row.addEventListener('click', () => {
                const zoneId = zoneNameToId(zone.zone);
                highlightZoneElement(zoneId);
                
                // Highlight only this row
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(r => {
                    if (r === row) {
                        r.classList.add('highlighted');
                        r.style.backgroundColor = '#e9f7e9';
                    } else {
                        r.classList.remove('highlighted');
                        r.style.backgroundColor = '';
                    }
                });
            });
            
            tableBody.appendChild(row);
        });
    }
    
    // Update score chart
    function updateScoreChart(zoneData, par) {
        const container = document.getElementById('score-chart');
        
        if (!zoneData || zoneData.length === 0) {
            container.innerHTML = '<div class="loading-placeholder"><p>No data available</p></div>';
            return;
        }
        
        // Calculate total average
        let totalScore = 0;
        let totalShots = 0;
        zoneData.forEach(zone => {
            totalScore += zone.avgScore * zone.count;
            totalShots += zone.count;
        });
        
        const averageScore = totalShots > 0 ? (totalScore / totalShots).toFixed(2) : 'N/A';
        const relativeToPar = totalShots > 0 ? (totalScore / totalShots - par).toFixed(2) : 'N/A';
        
        // Create a simple chart for now
        container.innerHTML = `
            <div style="padding: 20px; text-align: center;">
                <h3>Average Score: ${averageScore}</h3>
                <p>Relative to Par: ${relativeToPar > 0 ? '+' : ''}${relativeToPar}</p>
                <p>Based on ${totalShots} total shots</p>
                <div style="margin-top: 20px;">
                    <p>Best zones (lowest average scores):</p>
                    <ul style="list-style: none; padding: 0;">
                        ${zoneData.slice(0, 3).map(zone => 
                            `<li style="margin: 5px 0;"><strong>${zone.zone}</strong>: ${zone.avgScore.toFixed(1)}</li>`
                        ).join('')}
                    </ul>
                </div>
            </div>
        `;
    }
    
    // Update distribution chart
    function updateDistributionChart(zoneData) {
        const container = document.getElementById('distribution-chart');
        
        if (!zoneData || zoneData.length === 0) {
            container.innerHTML = '<div class="loading-placeholder"><p>No data available</p></div>';
            return;
        }
        
        // Calculate total shots
        const totalShots = zoneData.reduce((sum, zone) => sum + zone.count, 0);
        
        // Sort by shot count (most frequent first)
        const sortedData = [...zoneData].sort((a, b) => b.count - a.count);
        
        // Create simple bar chart
        container.innerHTML = `
            <div style="padding: 20px;">
                <h3>Shot Distribution</h3>
                <div style="margin-top: 20px;">
                    ${sortedData.slice(0, 5).map(zone => {
                        const percentage = ((zone.count / totalShots) * 100).toFixed(1);
                        return `
                            <div style="margin: 10px 0;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <span>${zone.zone}</span>
                                    <span>${zone.count} shots (${percentage}%)</span>
                                </div>
                                <div style="height: 20px; background-color: #e0e0e0; border-radius: 4px; margin-top: 5px;">
                                    <div style="height: 100%; width: ${percentage}%; background-color: var(--primary-color); border-radius: 4px;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Initialize the dashboard
    updateDashboard();
});
    </script>
</body>
</html>