<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Shot Analysis Dashboard</title>
    <link rel="stylesheet" href="styles/styles.css">
    <!-- <link rel="stylesheet" href="styles/zone-performance.css"> -->

</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">The Golf Blueprint</a>
            <ul class="nav-links">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="round-details.html" class="nav-link">Record Round</a></li>
                <li><a href="shot-analysis.html" class="nav-link">Shot Analysis</a></li>
                <li id="auth-link"><a href="login.html" class="nav-link">Login</a></li>
                <li id="profile-link" style="display: none;"><a href="profile.html" class="nav-link">My Profile</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Shot Analysis Dashboard</h1>
            <p>Choose a hole to view the scoring trends based on different zones</p>
        </div>

        <!-- Enhanced Hole Selector -->
        <div class="hole-selector-container">
            <select id="hole-select">
                <option value="1">Hole 1 - Par 4</option>
                <option value="2">Hole 2 - Par 3</option>
                <option value="3">Hole 3 - Par 5</option>
                <option value="4">Hole 4 - Par 4</option>
                <option value="5">Hole 5 - Par 5</option>
                <option value="6">Hole 6 - Par 3</option>
                <option value="7">Hole 7 - Par 4</option>
                <option value="8">Hole 8 - Par 5</option>
                <option value="9">Hole 9 - Par 3</option>
                <option value="10">Hole 10 - Par 4</option>
                <option value="11">Hole 11 - Par 3</option>
                <option value="12">Hole 12 - Par 4</option>
                <option value="13">Hole 13 - Par 5</option>
                <option value="14">Hole 14 - Par 4</option>
                <option value="15">Hole 15 - Par 4</option>
                <option value="16">Hole 16 - Par 4</option>
                <option value="17">Hole 17 - Par 3</option>
                <option value="18">Hole 18 - Par 4</option>
            </select>
        </div>

        <div class="dashboard-charts">
            <!-- SVG image (left side) -->
            <div class="svg-container-card">
                <h2>Hole Visualisation</h2>
                <div class="hole-svg-container" id="hole-visualization">
                    <img id="hole-image" src="" alt="Hole Image">
                    <!-- Zone highlights will be dynamically added here -->
                </div>
            </div>
            
            <!-- Combined Analysis (right side) -->
            <div class="combined-stats">
                <div class="hole-info">
                    <h2>Hole Analysis</h2>
                    <span class="hole-details" id="hole-details">Hole 1 - Par 4 - 420 yards</span>
                    <span class="rounds-count" id="rounds-count">using data from 15 rounds</span>
                    <div style="width: 100%; text-align: center; margin-top: 15px;">
                        <div style="width: 100%; text-align: center; margin-top: 15px;">
                            <div style="display: inline-block; background-color: #f8f8f8; padding: 4px 15px; border-radius: 6px;">
                                <span style="font-weight: 500; margin-right: 10px; vertical-align: middle;">Zone Colors:</span>
                                <span style="display: inline-block; margin: 0 10px; vertical-align: middle;">
                                    <span style="display: inline-block; width: 15px; height: 15px; background-color: rgba(59, 243, 46, 0.7); margin-right: 5px; border-radius: 3px; vertical-align: middle;"></span>
                                    <span style="font-size: 0.9em; vertical-align: middle;">Good</span>
                                </span>
                                <span style="display: inline-block; margin: 0 10px; vertical-align: middle;">
                                    <span style="display: inline-block; width: 15px; height: 15px; background-color: rgba(255, 152, 0, 0.7); margin-right: 5px; border-radius: 3px; vertical-align: middle;"></span>
                                    <span style="font-size: 0.9em; vertical-align: middle;">Average</span>
                                </span>
                                <span style="display: inline-block; margin: 0 10px; vertical-align: middle;">
                                    <span style="display: inline-block; width: 15px; height: 15px; background-color: rgba(255, 102, 102, 0.7); margin-right: 5px; border-radius: 3px; vertical-align: middle;"></span>
                                    <span style="font-size: 0.9em; vertical-align: middle;">Bad</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Score Chart Section -->
                <div id="score-chart" class="chart-container">
                    <div class="loading-placeholder">
                        <p>Select a hole to view score data...</p>
                    </div>
                </div>
                
                <!-- Zone Stats Table with Scrolling -->
                <div class="zone-stats">
                    <table id="zone-stats-table">
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>Avg. Score</th>
                                <th>Times Hit</th>
                                <th>Best Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Example data that will be dynamically replaced -->
                            <tr>
                                <td>Green</td>
                                <td class="score-cell">3.5</td>
                                <td>8</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Fairway</td>
                                <td class="score-cell">4.2</td>
                                <td>15</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Long Right</td>
                                <td class="score-cell">4.0</td>
                                <td>5</td>
                                <td>3</td>
                            </tr>
                            <tr>
                                <td>Short Right</td>
                                <td class="score-cell">4.8</td>
                                <td>6</td>
                                <td>4</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Load auth.js first -->
    <script src="scripts/auth.js"></script>
    
    
    <!-- Then load dashboard-specific script -->
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners for filter changes
    document.getElementById('hole-select').addEventListener('change', updateDashboard);
    
    // Hole data with yardage information
    const holeData = {
        1: { par: 4, yards: 420 },
        2: { par: 3, yards: 185 },
        3: { par: 5, yards: 565 },
        4: { par: 4, yards: 390 },
        5: { par: 5, yards: 530 },
        6: { par: 3, yards: 170 },
        7: { par: 4, yards: 430 },
        8: { par: 5, yards: 550 },
        9: { par: 3, yards: 190 },
        10: { par: 4, yards: 410 },
        11: { par: 3, yards: 200 },
        12: { par: 4, yards: 400 },
        13: { par: 5, yards: 560 },
        14: { par: 4, yards: 425 },
        15: { par: 4, yards: 415 },
        16: { par: 4, yards: 380 },
        17: { par: 3, yards: 175 },
        18: { par: 4, yards: 445 }
    };
    
    // Function to load hole-specific CSS
    function loadHoleCSS(holeNumber) {
        // Remove any existing hole-specific CSS
        const existingLink = document.getElementById('hole-specific-css');
        if (existingLink) {
            existingLink.remove();
        }
        
        // Add the new CSS link
        const link = document.createElement('link');
        link.id = 'hole-specific-css';
        link.rel = 'stylesheet';
        link.href = `styles/zones/hole${holeNumber}zones.css`;
        document.head.appendChild(link);
        
        console.log(`Loaded CSS: styles/zones/hole${holeNumber}zones.css`);
    }
    
    // Function to update the dashboard based on selected hole
    function updateDashboard() {
        const holeNumber = document.getElementById('hole-select').value;
        
        console.log(`Updating dashboard for hole ${holeNumber}`);
        
        // Update hole image
        const holeImage = document.getElementById('hole-image');
        holeImage.src = `images/${holeNumber}.svg`;
        holeImage.alt = `Hole ${holeNumber}`;
        
        // Update hole details information
        const holeDetails = document.getElementById('hole-details');
        const hole = holeData[holeNumber];
        holeDetails.textContent = `Hole ${holeNumber} - Par ${hole.par} - ${hole.yards} yards`;
        
        // Load hole-specific CSS
        loadHoleCSS(holeNumber);
        
        // Add hole-specific class to visualization container
        const container = document.getElementById('hole-visualization');
        container.className = `hole-svg-container hole${holeNumber}`;
        
        // Add all the zone elements (they'll be invisible but can be highlighted)
        addZoneElements(container, holeNumber);
        
        // Fetch data from API
        fetchHoleData(holeNumber);
    }
    
// Function to add all possible zone elements to the container
function addZoneElements(container, holeNumber) {
    // Clear existing zones first
    const existingZones = container.querySelectorAll('.zone');
    existingZones.forEach(zone => zone.remove());
    
// Define ALL possible zones across the entire course with duplicates removed
const allPossibleZones = [
    // Tee areas
    'teebox', 'tee',
    
    // Fairway sections
    'short-fairway', 'mid-fairway', 'long-fairway', 'shortfairway', 'midfairway', 'longfairway',
    
    // Rough areas
    'short-left-rough', 'mid-left-rough', 'long-left-rough',
    'short-right-rough', 'mid-right-rough', 'long-right-rough', 'rough', 'short-rough',
    'leftrough', 'shortrightrough', 'shortleftrough', 'midrightrough', 'midleftrough', 
    'longrightrough', 'longleftrough', 'longlongleftrough', 'longlongrightrough',
    
    // Green and surrounding areas
    'green',
    'short-left', 'short-right', 'long-left', 'long-right',
    'shortright', 'shortleft', 'longleft', 'longright', 'long',
    'backleft', 'backright',

    // Hazards
    'lake', 'left-lake', 'right-lake', 'left-bunker', 'right-bunker', 'fairway-bunker', 
    'bunker', 'green-bunkers', 'waterhazard', 'frontlake', 'rightlake', 'fairwaybunker',
    'potbunkers', 'shortlake', 'longlake',
    
    // Trees and wooded areas
    'left-trees', 'right-trees', 'left-green-side', 'right-green-side',
    'mid-left-trees', 'mid-right-trees', 'short-left-trees', 'short-right-trees',
    'long-left-trees', 'long-right-trees', 'long-mid-right-trees',
    'long-long-left-trees', 'long-long-right-trees', 'long-trees', 'right-trees',
    'rightrees', 'longtrees', 'leftrees', 'rightbush', 'shortleftrees', 'midleftrees',
    'longleftrees', 'shortrightrees', 'midrighttrees', 'longmidrightrees', 'shortrighttrees',
    'shortlefttrees', 'midlefttrees', 'longlefttrees', 'longrighttrees', 'longtrees',
    'longrightbushes', 'midrightbushes',
    
    // Boundaries
    'outer-rough', 'long-right-outer-rough', 'short-right-outer-rough', 
    'mid-right-outer-rough', 'mid-left-outer-rough', 'short-left-outer-rough',
    'out-of-bounds', 'longrightouter', 'shortrightouter', 'leftouterrough',
    'longrightouterrough', 'midrightouterrough', 'midroughtouter', 'shortroughouterrough'
];
    
    // Create all zone elements (they'll only be positioned if defined in the CSS)
    allPossibleZones.forEach(id => {
        const zone = document.createElement('div');
        zone.id = id;
        zone.className = 'zone';
        zone.dataset.zoneName = idToZoneName(id);
        container.appendChild(zone);
    });
    
    console.log(`Added ${allPossibleZones.length} potential zone elements for hole ${holeNumber}`);
}
    
    // Convert ID to zone name
    function idToZoneName(id) {
        // Convert hyphenated IDs to properly formatted zone names
        return id.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }
    
// Enhanced zone name to ID conversion with fallback support
function zoneNameToId(name, holeNumber) {
    const zoneName = name.toLowerCase();
    
    // For hole 1-9, prefer hyphenated IDs
    if (parseInt(holeNumber) < 9) {
        return zoneName.replace(/ /g, '-');
    } 
    // For hole 10+, prefer non-hyphenated IDs
    else {
        return zoneName.replace(/ /g, '');
    }
}

// Enhanced zone performance visualization with position checking
function updateZonePerformanceVisualization(zoneData, holeNumber) {
    const container = document.getElementById('hole-visualization');
    
    // Reset any existing zone styling
    const zones = container.querySelectorAll('.zone');
    zones.forEach(zone => {
        zone.style.backgroundColor = '';
        zone.classList.remove('good-zone', 'bad-zone', 'neutral-zone');
        zone.style.opacity = '0';
        zone.style.display = 'none';
    });
    
    // If no data, return
    if (!zoneData || zoneData.length === 0) return;
    
    // Find the range of scores to normalize the coloring
    let minScore = Infinity;
    let maxScore = -Infinity;
    
    zoneData.forEach(zone => {
        if (zone.avgScore < minScore) minScore = zone.avgScore;
        if (zone.avgScore > maxScore) maxScore = zone.avgScore;
    });
    
    // Calculate median score as reference point
    const scores = zoneData.map(zone => zone.avgScore);
    scores.sort((a, b) => a - b);
    const medianScore = scores.length % 2 === 0 
        ? (scores[scores.length/2 - 1] + scores[scores.length/2]) / 2 
        : scores[Math.floor(scores.length/2)];
    
    // Apply coloring to each zone
    zoneData.forEach(zone => {
        let zoneElement = null;
        const zoneName = zone.zone.toLowerCase();
        
        // For hole 1-9, try hyphenated ID first
        if (parseInt(holeNumber) < 10) {
            const hyphenatedId = zoneName.replace(/ /g, '-');
            zoneElement = document.getElementById(hyphenatedId);
            console.log(`Trying hyphenated ID for hole ${holeNumber}: ${hyphenatedId}`);
        } 
        // For hole 10+, try non-hyphenated ID first
        else {
            const nonHyphenatedId = zoneName.replace(/ /g, '');
            zoneElement = document.getElementById(nonHyphenatedId);
            console.log(`Trying non-hyphenated ID for hole ${holeNumber}: ${nonHyphenatedId}`);
        }
        
        // If not found, try the alternate format as backup
        if (!zoneElement) {
            if (parseInt(holeNumber) < 10) {
                // Try non-hyphenated as backup for holes 1-9
                const nonHyphenatedId = zoneName.replace(/ /g, '');
                zoneElement = document.getElementById(nonHyphenatedId);
                console.log(`Backup: trying non-hyphenated ID: ${nonHyphenatedId}`);
            } else {
                // Try hyphenated as backup for holes 10+
                const hyphenatedId = zoneName.replace(/ /g, '-');
                zoneElement = document.getElementById(hyphenatedId);
                console.log(`Backup: trying hyphenated ID: ${hyphenatedId}`);
            }
        }
        
        if (zoneElement) {
            // More lenient check for positioning - some CSS might be setting display:block
            // instead of position:absolute, or using other methods for positioning
            const computedStyle = window.getComputedStyle(zoneElement);
            
            // Check if element has any positioning defined (absolute, clip-path, or defined width/height)
            const hasAnyPositioning = 
                computedStyle.position !== 'static' || 
                computedStyle.clipPath !== 'none' || 
                (computedStyle.width !== 'auto' && computedStyle.height !== 'auto');
            
            // Proceed with styling even if minimal positioning is detected
            if (hasAnyPositioning || parseInt(holeNumber) >= 10) {
                // Calculate zone status and color
                let zoneStatus;
                let opacity;
                
                // Calculate performance relative to median
                const scoreDiff = zone.avgScore - medianScore;
                const normalizedDiff = (maxScore > minScore) ? 
                    scoreDiff / (maxScore - minScore) * 2 : 0; // Avoid division by zero
                
                if (zone.avgScore < medianScore - (maxScore - minScore) * 0.15) {
                    zoneStatus = 'good-zone';
                    // Blue for better zones
                    opacity = 0.5 + Math.min(0.4, Math.abs(normalizedDiff) * 0.5);
                    zoneElement.style.backgroundColor = `rgba(59, 243, 46, ${opacity})`;
                } else if (zone.avgScore > medianScore + (maxScore - minScore) * 0.15) {
                    zoneStatus = 'bad-zone';
                    // Darker red for worse zones
                    opacity = 0.6 + Math.min(0.3, Math.abs(normalizedDiff) * 0.4);
                    zoneElement.style.backgroundColor = `rgba(255, 102, 102, ${opacity})`;
                } else {
                    zoneStatus = 'neutral-zone';
                    // Darker orange for neutral zones
                    opacity = 0.5;
                    zoneElement.style.backgroundColor = `rgba(255, 152, 0, ${opacity})`;
                }
                
                // Add status class
                zoneElement.classList.add(zoneStatus);
                
                // Make zone visible again
                zoneElement.style.display = '';
                zoneElement.style.opacity = '1';
                
                // Add tooltip
                zoneElement.title = `${zone.zone}: Avg. Score ${zone.avgScore.toFixed(1)} (${zone.count} shots)`;
                
                // Add click handler
                zoneElement.addEventListener('click', () => {
                    highlightTableRow(zone.zone);
                });
                
                console.log(`Successfully colored zone: ${zone.zone} with ID: ${zoneElement.id}`);
            } else {
                console.log(`Skipped zone ${zone.zone} (ID: ${zoneElement.id}) - No positioning defined`);
            }
        } else {
            console.log(`Could not find element for zone "${zone.zone}" on hole ${holeNumber}`);
        }
    });
}
    
// Function to fetch hole data from API
function fetchHoleData(holeNumber) {
    // Show loading state
    document.getElementById('score-chart').innerHTML = '<div class="loading-placeholder"><p>Loading data...</p></div>';
    document.getElementById('rounds-count').textContent = 'loading data...';
    
    // First, fetch the round count for this hole
    fetch(`/api/round-count?hole=${holeNumber}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            return response.json();
        })
        .then(countData => {
            const roundCount = countData.count;
            
            // Update round count display
            document.getElementById('rounds-count').textContent = `using data from ${roundCount} rounds`;
            
            // Then fetch the hole statistics
            return fetch(`/api/hole-stats?hole=${holeNumber}&shot=all&datePeriod=all-time`);
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API response:', data);
            
            if (data && data.zones && data.zones.length > 0) {
                // Update visualizations - pass holeNumber to all functions
                updateZonePerformanceVisualization(data.zones, holeNumber);
                updateZoneStatsTable(data.zones, holeNumber);
                updateScoreChart(data.zones, holeData[holeNumber].par);
            } else {
                // Handle no data case
                document.getElementById('score-chart').innerHTML = 
                    '<div class="loading-placeholder"><p>No data available for this hole</p></div>';
                updateZonePerformanceVisualization([], holeNumber);
                updateZoneStatsTable([], holeNumber);
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            document.getElementById('score-chart').innerHTML = 
                `<div class="loading-placeholder"><p>Error: ${error.message}</p></div>`;
            document.getElementById('rounds-count').textContent = 'error loading data';
        });
}
    
    // Highlight a table row
    function highlightTableRow(zoneName) {
        const table = document.getElementById('zone-stats-table');
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const rowZone = row.querySelector('td').textContent;
            if (rowZone === zoneName) {
                row.style.backgroundColor = '#e9f7e9';
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                row.classList.add('highlighted');
            } else {
                row.style.backgroundColor = '';
                row.classList.remove('highlighted');
            }
        });
    }
    
// Updated highlight zone element function that handles both naming conventions
function highlightZoneElement(zoneId, holeNumber) {
    let zoneElement = null;
    
    // For hole 1-9, try hyphenated ID first
    if (parseInt(holeNumber) < 0) {
        zoneElement = document.getElementById(zoneId);
    } 
    // For hole 9+, try non-hyphenated ID first
    else {
        // Try without hyphens first
        const nonHyphenatedId = zoneId.replace(/-/g, '');
        zoneElement = document.getElementById(nonHyphenatedId);
        
        // If not found, try the original ID
        if (!zoneElement) {
            zoneElement = document.getElementById(zoneId);
        }
    }
    
    if (!zoneElement) {
        console.log(`Could not find zone element with ID: ${zoneId} for hole ${holeNumber}`);
        return;
    }
    
    // Add temporary class to highlight the zone
    zoneElement.classList.add('zone-active');
    zoneElement.classList.add('pulse-animation');
    
    // Flash effect
    setTimeout(() => {
        zoneElement.classList.remove('zone-active');
        zoneElement.classList.remove('pulse-animation');
    }, 1500);
}

// Update the zone stats table click handler
function updateZoneStatsTable(zoneData, holeNumber) {
    const tableBody = document.querySelector('#zone-stats-table tbody');
    tableBody.innerHTML = '';
    
    if (!zoneData || zoneData.length === 0) {
        return;
    }
    
    // Sort zones by average score (best to worst)
    zoneData.sort((a, b) => a.avgScore - b.avgScore);
    
    zoneData.forEach(zone => {
        const row = document.createElement('tr');
        
        const zoneCell = document.createElement('td');
        zoneCell.textContent = zone.zone;
        
        const scoreCell = document.createElement('td');
        scoreCell.className = 'score-cell';
        scoreCell.textContent = zone.avgScore.toFixed(1);
        
        const countCell = document.createElement('td');
        countCell.textContent = zone.count;
        
        const bestCell = document.createElement('td');
        bestCell.textContent = zone.bestScore;
        
        row.appendChild(zoneCell);
        row.appendChild(scoreCell);
        row.appendChild(countCell);
        row.appendChild(bestCell);
        
        // Add click handler to highlight the zone
        row.addEventListener('click', () => {
            const zoneId = zoneNameToId(zone.zone, holeNumber);
            highlightZoneElement(zoneId, holeNumber);
            
            // Highlight only this row
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(r => {
                if (r === row) {
                    r.classList.add('highlighted');
                    r.style.backgroundColor = '#e9f7e9';
                } else {
                    r.classList.remove('highlighted');
                    r.style.backgroundColor = '';
                }
            });
        });
        
        tableBody.appendChild(row);
    });
}
    
    // Update score chart
    function updateScoreChart(zoneData, par) {
        const container = document.getElementById('score-chart');
        
        if (!zoneData || zoneData.length === 0) {
            container.innerHTML = '<div class="loading-placeholder"><p>No data available</p></div>';
            return;
        }
        
        // Calculate total average
        let totalScore = 0;
        let totalShots = 0;
        zoneData.forEach(zone => {
            totalScore += zone.avgScore * zone.count;
            totalShots += zone.count;
        });
        
        const averageScore = totalShots > 0 ? (totalScore / totalShots).toFixed(2) : 'N/A';
        const relativeToPar = totalShots > 0 ? (totalScore / totalShots - par).toFixed(2) : 'N/A';
        
        // Create a side-by-side layout
        container.innerHTML = `
            <div style="padding: 15px;">
                <div style="display: flex; justify-content: space-between; gap: 20px;">
                    <!-- Left column: Average score -->
                    <div style="flex: 1; background-color: #f8f8f8; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: var(--primary-color);">Average Score: ${averageScore}</h3>
                        <p style="font-weight: 500;">Relative to Par: ${relativeToPar > 0 ? '+' : ''}${relativeToPar}</p>
                        <p>Based on ${totalShots} total shots</p>
                    </div>
                    
                    <!-- Right column: Best zones -->
                    <div style="flex: 1; background-color: #f8f8f8; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: var(--primary-color);">Best Zones</h3>
                        <ul style="list-style: none; padding: 0; margin: 10px 0 0 0;">
                            ${zoneData.slice(0, 3).map(zone => 
                                `<li style="margin: 5px 0;"><strong>${zone.zone}</strong>: ${zone.avgScore.toFixed(1)}</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Initialize the dashboard
    updateDashboard();
});
    </script>
</body>
</html>


